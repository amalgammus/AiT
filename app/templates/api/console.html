{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>API Console</h2>

    <div class="row">
        <!-- Configuration Block -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>API Configurations</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Select Configuration:</label>
                        <select class="form-select" id="configSelect" onchange="loadConfig(this.value)">
                            <option value="">Select configuration...</option>
                            {% for config in select_form.config.choices %}
                                <option value="{{ config[0] }}" {% if selected_config and selected_config.id == config[0] %}selected{% endif %}>
                                    {{ config[1] }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <hr>

                    <form method="POST" id="configForm">
                        <input type="hidden" name="form_type" value="save_config">
                        <input type="hidden" name="config_id" value="{{ selected_config.id if selected_config else '' }}">
                        {{ config_form.hidden_tag() }}

                        <div class="mb-3">
                            {{ config_form.name.label(class="form-label") }}
                            {{ config_form.name(class="form-control", id="name") }}
                        </div>

                        <div class="mb-3">
                            {{ config_form.base_url.label(class="form-label") }}
                            {{ config_form.base_url(class="form-control", id="base_url", placeholder="https://ip:port") }}
                        </div>

                        <div class="mb-3">
                            {{ config_form.secret_key.label(class="form-label") }}
                            {{ config_form.secret_key(class="form-control", type="password", id="secret_key") }}
                        </div>

                        <div class="mb-3 form-check">
                            {{ config_form.verify_ssl(class="form-check-input", id="verify_ssl") }}
                            {{ config_form.verify_ssl.label(class="form-check-label") }}
                        </div>

                        <div class="mb-3 form-check">
                            {{ config_form.is_default(class="form-check-input", id="is_default") }}
                            {{ config_form.is_default.label(class="form-check-label") }}
                        </div>

                        <button type="submit" class="btn btn-success w-100">
                            {{ 'Update' if selected_config else 'Save' }} Configuration
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- API Request Block -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>API Request</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="apiForm">
                        <input type="hidden" name="form_type" value="execute_api">
                        <input type="hidden" name="selected_config_id" id="selected_config_id" value="{{ selected_config.id if selected_config else '' }}">

                        <div class="mb-3">
                            <label class="form-label">Selected Configuration:</label>
                            <input type="text" class="form-control" readonly
                                   value="{{ selected_config.name if selected_config else 'None (using default)' }}" id="selected_config_name">
                        </div>

                        <div class="mb-3">
                            <label for="api_method" class="form-label">API Method</label>
                            <select class="form-select" id="api_method" name="api_method" required
                                    onchange="updateFormFields()">
                                <option value="">Select method...</option>
                                {% for method in api_methods %}
                                <option value="{{ method.name }}" {% if request.form.api_method == method.name %}selected{% endif %}>
                                    {{ method.name }} ({{ method.method }}) - {{ method.description }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Crew Info Fields -->
                        <div id="crew_info_fields" style="display: none;">
                            <div class="mb-3">
                                <label for="crew_id" class="form-label">Crew ID*</label>
                                <input type="number" class="form-control" id="crew_id" name="crew_id"
                                       value="{{ request.form.crew_id if request.form.crew_id else '' }}">
                            </div>
                            <div class="mb-3">
                                <label for="fields" class="form-label">Fields (comma separated)</label>
                                <input type="text" class="form-control" id="fields" name="fields"
                                       value="{{ request.form.fields if request.form.fields else '' }}"
                                       placeholder="code,name,driver_id,car_id">
                            </div>
                        </div>

                        <!-- Change Order State Fields -->
                        <div id="change_order_state_fields" style="display: none;">
                            <div class="mb-3">
                                <label for="order_id" class="form-label">Order ID*</label>
                                <input type="number" class="form-control" id="order_id" name="order_id"
                                       value="{{ request.form.order_id if request.form.order_id else '' }}">
                            </div>
                            <div class="mb-3">
                                <label for="new_state" class="form-label">New State*</label>
                                <select class="form-select" id="new_state" name="new_state">
                                    <option value="">Loading states...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="cancel_order_penalty_sum" class="form-label">Cancel Order Penalty Sum (optional)</label>
                                <input type="number" step="0.01" class="form-control" id="cancel_order_penalty_sum" name="cancel_order_penalty_sum"
                                       value="{{ request.form.cancel_order_penalty_sum if request.form.cancel_order_penalty_sum else '' }}">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Execute</button>
                    </form>

                    {% if result %}
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5>Response:</h5>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary active"
                                        id="jsonViewBtn" onclick="switchView('json')">JSON</button>
                                <button type="button" class="btn btn-outline-secondary"
                                        id="tableViewBtn" onclick="switchView('table')">Table</button>
                            </div>
                        </div>

                        <!-- JSON View -->
                        <div id="jsonView">
                            <pre class="bg-light p-3 rounded">{{ result }}</pre>
                        </div>

                        <!-- Table View -->
                        <div id="tableView" style="display: none;">
                            {% if method_name == 'get_crew_groups_list' %}
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for group in result_json.data.crew_groups %}
                                        <tr>
                                            <td>{{ group.id }}</td>
                                            <td>{{ group.name }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>

                            {% elif method_name == 'get_order_states_list' %}
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>State Type</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for state in result_json.data.order_states %}
                                        <tr>
                                            <td>{{ state.id }}</td>
                                            <td>{{ state.name }}</td>
                                            <td>{{ state.state_type }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>

                            {% elif method_name == 'get_crew_states_list' %}
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>State Type</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for state in result_json.data.crew_states %}
                                        <tr>
                                            <td>{{ state.id }}</td>
                                            <td>{{ state.name }}</td>
                                            <td>{{ state.state_type }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>

                            {% elif method_name == 'get_crew_info' %}
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6>Crew Info</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            {% for key, value in result_json.data.items() %}
                                                {% if key not in ['attribute_values', 'order_params'] %}
                                                <div class="col-md-4 mb-2">
                                                    <strong>{{ key }}:</strong>
                                                    <span>{{ value }}</span>
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                {% if result_json.data.attribute_values %}
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6>Attribute Values</h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Bool Value</th>
                                                    <th>Num Value</th>
                                                    <th>Str Value</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for attr in result_json.data.attribute_values %}
                                                <tr>
                                                    <td>{{ attr.id }}</td>
                                                    <td>{{ attr.bool_value if attr.bool_value is not none else '' }}</td>
                                                    <td>{{ attr.num_value if attr.num_value is not none else '' }}</td>
                                                    <td>{{ attr.str_value if attr.str_value is not none else '' }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endif %}

                            {% elif method_name == 'change_order_state' %}
                                <div class="alert alert-success">
                                    <h6>Order state changed successfully</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Order ID:</strong> {{ result_json.data.order_id }}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>New State:</strong> {{ result_json.data.new_state }}
                                        </div>
                                    </div>
                                </div>

                            {% else %}
                                <div class="alert alert-info">
                                    Table view not available for this response type
                                </div>
                            {% endif %}
                        </div>

                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard()">
                                <i class="bi bi-clipboard"></i> Copy to clipboard
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function loadConfig(configId) {
        if (!configId) {
            document.getElementById('selected_config_id').value = '';
            document.getElementById('selected_config_name').value = 'None (using default)';
            return;
        }

        const select = document.getElementById('configSelect');
        const originalText = select.selectedOptions[0].text;
        select.disabled = true;
        select.selectedOptions[0].text = 'Loading...';

        fetch(`/api/get_config?config_id=${configId}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.config) {
                    document.getElementById('name').value = data.config.name;
                    document.getElementById('base_url').value = data.config.base_url;
                    document.getElementById('secret_key').value = data.config.secret_key;
                    document.getElementById('verify_ssl').checked = data.config.verify_ssl;
                    document.getElementById('is_default').checked = data.config.is_default;
                    document.querySelector('input[name="config_id"]').value = data.config.id;

                    document.getElementById('selected_config_id').value = data.config.id;
                    document.getElementById('selected_config_name').value = data.config.name;
                }
            })
            .catch(error => {
                console.error('Error loading config:', error);
                alert('Failed to load configuration');
            })
            .finally(() => {
                select.disabled = false;
                select.selectedOptions[0].text = originalText;
            });
    }

    function updateFormFields() {
        const method = document.getElementById('api_method').value;
        const crewFields = document.getElementById('crew_info_fields');
        const orderStateFields = document.getElementById('change_order_state_fields');

        crewFields.style.display = method === 'get_crew_info' ? 'block' : 'none';
        orderStateFields.style.display = method === 'change_order_state' ? 'block' : 'none';

        if (method === 'change_order_state') {
            loadOrderStates();
        }
    }

    function loadOrderStates() {
        const newStateSelect = document.getElementById('new_state');
        newStateSelect.innerHTML = '<option value="" class="loading">Loading states...</option>';
        newStateSelect.disabled = true;

        fetch(`{{ url_for('api.api_console') }}?form_type=load_states`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            newStateSelect.innerHTML = '<option value="">Select state...</option>';
            newStateSelect.disabled = false;

            if (data.states && data.states.length > 0) {
                data.states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state.id;
                    option.textContent = `${state.id} - ${state.name}`;
                    newStateSelect.appendChild(option);
                });
            } else if (data.error) {
                newStateSelect.innerHTML = `<option value="">Error: ${data.error}</option>`;
            } else {
                newStateSelect.innerHTML = '<option value="">No states available</option>';
            }
        })
        .catch(error => {
            console.error('Error loading order states:', error);
            newStateSelect.innerHTML = '<option value="">Error loading states</option>';
            newStateSelect.disabled = false;
        });
    }

    function switchView(viewType) {
        const jsonView = document.getElementById('jsonView');
        const tableView = document.getElementById('tableView');
        const jsonBtn = document.getElementById('jsonViewBtn');
        const tableBtn = document.getElementById('tableViewBtn');

        if (viewType === 'json') {
            jsonView.style.display = 'block';
            tableView.style.display = 'none';
            jsonBtn.classList.add('active');
            tableBtn.classList.remove('active');
        } else {
            jsonView.style.display = 'none';
            tableView.style.display = 'block';
            jsonBtn.classList.remove('active');
            tableBtn.classList.add('active');
        }
    }

    function copyToClipboard() {
        const text = document.querySelector('pre').innerText;
        navigator.clipboard.writeText(text).then(() => {
            const toast = new bootstrap.Toast(document.getElementById('copyToast'));
            toast.show();
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        updateFormFields();
    });
</script>

<style>
    .btn-group .btn.active {
        background-color: #0d6efd;
        color: white;
    }
    pre {
        max-height: 500px;
        overflow-y: auto;
    }
    .table {
        font-size: 0.9rem;
    }
    .card-body .row > div {
        padding: 0.25rem;
    }
    select[disabled] {
        opacity: 0.7;
        cursor: not-allowed;
    }
    .loading {
        color: #6c757d;
        font-style: italic;
    }
</style>

<!-- Toast notification for copy -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="copyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">API Console</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            JSON copied to clipboard!
        </div>
    </div>
</div>
{% endblock %}