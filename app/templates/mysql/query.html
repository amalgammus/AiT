{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2><i class="bi bi-database"></i> MySQL Query Tool</h2>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Query Parameters</h5>
        </div>
        <div class="card-body">
            <form method="POST">
                {{ form.hidden_tag() }}

                <div class="row mb-3">
                    <div class="col-md-6">
                        {{ form.start_date.label(class="form-label") }}
                        {{ form.start_date(class="form-control") }}
                    </div>
                    <div class="col-md-6">
                        {{ form.end_date.label(class="form-label") }}
                        {{ form.end_date(class="form-control") }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        {{ form.client_id.label(class="form-label") }}
                        {{ form.client_id(class="form-control") }}
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-play-circle"></i> Execute Query
                </button>
            </form>
        </div>
    </div>

    {% if results %}
    <div class="card">
        <div class="card-header bg-success text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Query Results</h5>
                <span class="badge bg-light text-dark">
                    {{ results|length }} row{% if results|length != 1 %}s{% endif %}
                </span>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="resultsTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            {% for column in results[0].keys() %}
                            <th>{{ column }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in results %}
                        <tr>
                            {% for value in row.values() %}
                            <td>
                                {% if value is none %}
                                    NULL
                                {% elif value is string %}
                                    {{ value }}
                                {% elif value is number %}
                                    {{ value|round(2) if value is float else value }}
                                {% else %}
                                    {{ value|string }}
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="{{ results[0].keys()|length }}" style="text-align: right">
                                <span class="hours-summary"></span>
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Стили DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css">

{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Подключаем необходимые библиотеки -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.colVis.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.flash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

<style>
/* Основные стили для верхнего блока управления */
.dataTables_wrapper .top-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
    margin: 10px;
}

/* Стили для выбора количества строк */
.dataTables_wrapper .dataTables_length {
    margin: 0;
    display: flex;
    align-items: center;
}

.dataTables_wrapper .dataTables_length select {
    margin: 0 5px;
    height: calc(1.5em + 0.75rem + 2px);
}

/* Стили для поля поиска */
.dataTables_wrapper .dataTables_filter {
    margin: 0;
    display: flex;
    align-items: center;
}

.dataTables_wrapper .dataTables_filter input {
    margin-left: 5px;
    height: calc(1.5em + 0.75rem + 2px);
}

/* Стили для контейнера кнопок */
.buttons-container {
    display: flex;
    align-items: center;
    gap: 5px;
    margin: 0;
}

.buttons-container .btn {
    height: calc(1.5em + 0.75rem + 2px);
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Стили для нижнего блока управления */
.bottom-controls {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}

/* Стили для футера */
#resultsTable tfoot th {
    text-align: right !important;
    padding-right: 20px;
    font-weight: bold;
    background-color: #f8f9fa;
    border-top: 2px solid #dee2e6;
}

.hours-summary {
    white-space: nowrap;
    padding-right: 15px;
}
</style>

<script>
$(document).ready(function() {
    // Функция для обновления футера
    function updateFooter(table) {
        var hoursColumnIndex = $('#resultsTable th:contains("Hours")').index();
        if (hoursColumnIndex < 0) return;

        // Сумма для текущей страницы
        var pageSum = table.column(hoursColumnIndex, { page: 'current', search: 'applied' })
            .data()
            .reduce(function(a, b) { return parseFloat(a) + parseFloat(b); }, 0);

        // Сумма для всех отфильтрованных данных
        var filteredSum = table.column(hoursColumnIndex, { search: 'applied' })
            .data()
            .reduce(function(a, b) { return parseFloat(a) + parseFloat(b); }, 0);

        $('.hours-summary').html(
            'Page Hours: ' + pageSum.toFixed(2) + ' h | ' +
            'Total Hours: ' + filteredSum.toFixed(2) + ' h'
        );
    }

    // Инициализация DataTable
    var table = $('#resultsTable').DataTable({
        dom: '<"top"<"top-controls"<"buttons-container"B><"length-container"l><"search-container"f>>>rt<"bottom"<"bottom-controls"ip>><"clear">',
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Все"]],
        pageLength: 25,
        buttons: [
            {
                extend: 'copy',
                text: '<i class="bi bi-clipboard"></i> Copy',
                className: 'btn btn-primary btn-sm',
                exportOptions: {
                    columns: ':visible',
                    modifier: {
                        search: 'applied'
                    }
                }
            },
            {
                extend: 'csv',
                text: '<i class="bi bi-file-earmark-text"></i> CSV',
                className: 'btn btn-info btn-sm',
                title: 'Query Report',
                exportOptions: {
                    columns: ':visible',
                    modifier: {
                        search: 'applied'
                    }
                }
            },
            {
                extend: 'pdf',
                text: '<i class="bi bi-file-earmark-pdf"></i> PDF',
                title: 'Query Report',
                className: 'btn btn-danger btn-sm',
                exportOptions: {
                    columns: ':visible',
                    modifier: {
                        search: 'applied'
                    }
                },
                customize: function(doc) {
                    var totalSum = table.column(
                        $('#resultsTable th:contains("Hours")').index(),
                        { search: 'applied' }
                    ).data().reduce(function(a, b) { return parseFloat(a) + parseFloat(b); }, 0);

                    doc.content.push({
                        text: 'Total Hours: ' + totalSum.toFixed(2),
                        margin: [0, 10, 0, 0],
                        alignment: 'right',
                        bold: true
                    });

                    doc.defaultStyle = { fontSize: 9, color: '#333' };
                    doc.styles.title = { fontSize: 12, bold: true, alignment: 'center', margin: [0, 0, 0, 10] };
                    doc.styles.tableHeader = { fillColor: '#2c3e50', color: '#ffffff', bold: true, margin: [5, 5, 5, 5], alignment: 'center'};
                    doc.pageMargins = [20, 40, 20, 30];
                }
            },
            {
                extend: 'excel',
                text: '<i class="bi bi-file-earmark-excel"></i> Excel',
                className: 'btn btn-success btn-sm',
                title: 'Query Report',
                exportOptions: {
                    columns: ':visible',
                    modifier: {
                        search: 'applied'
                    }
                }
            },
            {
                extend: 'print',
                text: '<i class="bi bi-printer"></i> Print',
                className: 'btn btn-secondary btn-sm',
                title: 'Query Report',
                exportOptions: {
                    columns: ':visible',
                    modifier: {
                        search: 'applied'
                    }
                },
                customize: function(win) {
                    $(win.document.body).find('h1').css('text-align', 'center');
                    $(win.document.body).find('table').addClass('display').css('font-size', '10px');

                    var totalSum = table.column(
                        $('#resultsTable th:contains("Hours")').index(),
                        { search: 'applied' }
                    ).data().reduce(function(a, b) { return parseFloat(a) + parseFloat(b); }, 0);

                    $(win.document.body).append(
                        '<div style="text-align:right;margin-top:20px;font-weight:bold;">' +
                        'Total Hours: ' + totalSum.toFixed(2) + '</div>'
                    );
                }
            }
        ],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/ru.json',
            lengthMenu: "Show _MENU_ records",
            info: "Showing _START_ to _END_ of _TOTAL_ records",
            infoEmpty: "No records to display",
            infoFiltered: "(filtered from _MAX_ records)",
            search: "Search:",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        },
        responsive: true,
        order: [[0, 'desc']],
        columnDefs: [
            {
                targets: '_all',
                className: 'dt-head-center'
            }
        ],
        initComplete: function() {
            updateFooter(table);
        },
        drawCallback: function() {
            updateFooter(table);
        }
    });

    // Обработчики событий
    $('#resultsTable').on('length.dt search.dt page.dt', function() {
        updateFooter(table);
    });
});
</script>
{% endblock %}